<!DOCTYPE html>
<html
    lang="ko"
    ng-app="busApp"
>
    <head>
        <meta charset="UTF-8" />
        <title>ì‹¤ìŠµ í”„ë¡œì íŠ¸</title>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1"
        />

        <!-- AngularJS -->
        <script src="/lib/angular.js"></script>
        <script src="/lib/angular-route.js"></script>
        <!-- App -->
        <script src="/app.js"></script>

        <style>
            /* âœ… Angularì˜ ng-show/ng-hide ë™ì‘ì„ í™•ì‹¤íˆ ì§€ì› */
            .ng-hide {
                display: none !important;
            }
            [ng-cloak] {
                display: none;
            }

            :root {
                --blue: #3478f6;
                --blue-600: #2c63ca;
                --gray-100: #f5f7fb;
                --gray-200: #edf0f5;
                --gray-400: #cfd7e3;
                --green: #2ecc71;
                --danger: #e74c3c;
                --text-600: #2c3e50;
            }
            html,
            body {
                height: 100%;
            }
            body {
                font-family: 'Segoe UI', system-ui, -apple-system, Roboto, Apple SD Gothic Neo, Malgun Gothic, sans-serif;
                background: #f7f9fc;
                margin: 0;
                color: #1f2d3d;
            }
            .topbar {
                background: #3498db;
                color: #fff;
                padding: 12px 16px;
            }
            .topbar .inner {
                max-width: 1100px;
                margin: 0 auto;
                display: flex;
                align-items: center;
                gap: 12px;
            }
            .brand {
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 700;
                font-size: 18px;
                margin-left: 4px;
            }
            .nav {
                display: flex;
                align-items: center;
                gap: 18px;
                margin: 0 auto;
            }
            .nav > .item {
                position: relative;
            }
            .nav > .item > a {
                color: #fff;
                text-decoration: none;
                padding: 8px 10px;
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.35);
                font-size: 14px;
                display: inline-block;
            }
            .nav > .item > a:hover {
                background: rgba(255, 255, 255, 0.12);
            }
            /* âœ… dropdown: ê¸°ë³¸ block, ng-hideë¡œë§Œ ìˆ¨ê¹€ */
            .dropdown {
                position: absolute;
                left: 0;
                top: 110%;
                background: #fff;
                color: #111827;
                border-radius: 10px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
                min-width: 200px;
                padding: 8px;
                border: 1px solid #e5e7eb;
                display: block;
                z-index: 10;
            }
            .dropdown a {
                display: block;
                padding: 8px 10px;
                border-radius: 8px;
                color: #111827;
                text-decoration: none;
                font-size: 14px;
            }
            .dropdown a:hover {
                background: #f5f7fb;
            }
            .nav-right {
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 14px;
            }
            .btn-link {
                color: #fff;
                text-decoration: none;
                border: 1px solid rgba(255, 255, 255, 0.6);
                padding: 6px 10px;
                border-radius: 10px;
            }
            .btn-link:hover {
                background: rgba(255, 255, 255, 0.12);
            }

            main {
                max-width: 980px;
                margin: 28px auto 40px;
                padding: 20px;
                background: #fff;
                border-radius: 16px;
                box-shadow: 0 10px 30px rgba(31, 38, 135, 0.08);
            }
            .search-box {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 10px;
                margin-bottom: 16px;
            }
            .search-box input {
                padding: 10px 12px;
                width: 60%;
                font-size: 16px;
                border: 1px solid var(--gray-400);
                border-radius: 10px;
            }
            .search-box button {
                padding: 10px 16px;
                background: var(--green);
                color: #fff;
                border: 0;
                border-radius: 10px;
                cursor: pointer;
            }
            .generate-button {
                display: flex;
                justify-content: center;
                margin-bottom: 16px;
            }
            .generate-button button {
                padding: 10px 20px;
                background: #3498db;
                color: #fff;
                border: 0;
                border-radius: 10px;
                font-size: 16px;
                cursor: pointer;
            }

            .status-box {
                margin-bottom: 16px;
                text-align: center;
                font-size: 15px;
                padding: 10px;
                border-radius: 10px;
            }
            .status-success {
                background: #e8f5e9;
                color: #2e7d32;
                border: 1px solid #c8e6c9;
            }
            .status-error {
                background: #ffebee;
                color: #c62828;
                border: 1px solid #ef9a9a;
            }
            .status-info {
                background: #e3f2fd;
                color: #1565c0;
                border: 1px solid #90caf9;
            }

            #output {
                max-height: 400px;
                overflow-y: auto;
                padding: 15px;
                border: 1px solid #edf0f5;
                border-radius: 12px;
                background: #fbfdff;
            }
            ul {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            li {
                margin-bottom: 8px;
                font-size: 16px;
                line-height: 1.4;
            }
            strong {
                color: #2c3e50;
            }

            .user-table {
                width: 100%;
                border-collapse: collapse;
                background: #fff;
                border-radius: 12px;
                overflow: hidden;
                border: 1px solid #edf0f5;
            }
            .user-table th,
            .user-table td {
                border-bottom: 1px solid #eee;
                padding: 10px 12px;
                text-align: left;
                font-size: 14px;
                vertical-align: middle;
            }
            .user-table thead th {
                background: #f5f7fb;
                font-weight: 600;
            }
            .user-table tbody tr:hover td {
                background: #fbfdff;
            }
            .inline-input {
                width: 95%;
                padding: 6px 8px;
                border: 1px solid #d6dbe7;
                border-radius: 8px;
            }

            .section-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin: 6px 0 14px;
            }
            .section-title {
                display: flex;
                align-items: center;
                gap: 10px;
                color: var(--text-600);
            }
            .section-title .dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: var(--blue);
                box-shadow: 0 0 0 3px rgba(52, 120, 246, 0.15);
            }
            .actions {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .btn {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 9px 14px;
                border-radius: 10px;
                border: 1px solid var(--gray-400);
                background: #fff;
                color: #263238;
                cursor: pointer;
                font-weight: 600;
            }
            .btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
            }
            .btn-primary {
                border-color: var(--blue);
                background: var(--blue);
                color: #fff;
            }
            .btn-primary:hover {
                background: var(--blue-600);
                border-color: var(--blue-600);
            }
            .btn-ghost {
                background: #fff;
                color: #2c3e50;
                border-color: var(--gray-400);
            }
            .btn-danger {
                border-color: var(--danger);
                background: var(--danger);
                color: #fff;
            }

            .pill {
                padding: 3px 8px;
                border-radius: 999px;
                font-size: 12px;
                border: 1px solid var(--gray-400);
            }
            .pill.green {
                background: #e8f5e9;
                color: #2e7d32;
                border-color: #c8e6c9;
            }
            .pill.gray {
                background: #f1f1f1;
                color: #555;
            }

            .hero {
                display: flex;
                gap: 24px;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #f5f9ff 0%, #eef7ff 100%);
                border: 1px solid #e6eeff;
                border-radius: 16px;
                padding: 28px 24px;
                margin-bottom: 10px;
                text-align: center;
            }
            .hero h2 {
                margin: 0 0 8px;
                font-size: 24px;
                color: #1f2d3d;
            }
            .hero p {
                margin: 0;
                color: #4a5568;
            }
            .hero .cta,
            .hero-illustration,
            .quick-cards {
                display: none;
            }
        </style>
    </head>

    <body
        ng-controller="RootCtrl"
        ng-cloak
    >
        <!-- Top bar -->
        <div class="topbar">
            <div class="inner">
                <div class="brand"><span>ì‹¤ìŠµ í”„ë¡œì íŠ¸</span></div>

                <!-- ìƒë‹¨ ë„¤ë¹„ -->
                <nav
                    class="nav"
                    role="navigation"
                    aria-label="ì£¼ìš” ë©”ë‰´"
                    ng-init="mBoard={_open:false}; mAdmin={_open:false}"
                >
                    <div class="item">
                        <a
                            href="#/users?tab=bus"
                            ng-click="$event.preventDefault(); goBusTab()"
                            >ë²„ìŠ¤ì •ë³´</a
                        >
                    </div>

                    <!-- ê²Œì‹œíŒ -->
                    <div
                        class="item"
                        ng-mouseenter="onMenuEnter(mBoard)"
                        ng-mouseleave="onMenuLeave(mBoard)"
                    >
                        <a
                            href="#/board"
                            ng-click="navTo('#/board', $event)"
                            aria-haspopup="true"
                            aria-expanded="{{!!mBoard._open}}"
                            >ê²Œì‹œíŒ</a
                        >
                        <div
                            class="dropdown"
                            ng-show="mBoard._open"
                            ng-click="$event.stopPropagation()"
                        >
                            <a
                                href="#/board/bus"
                                ng-click="navTo('#/board/bus', $event)"
                                >ëŒ€êµ¬ë²„ìŠ¤ ê²Œì‹œíŒ</a
                            >
                            <a
                                href="#/board/normal"
                                ng-click="navTo('#/board/normal', $event)"
                                >ì¼ë°˜ ê²Œì‹œíŒ</a
                            >
                        </div>
                    </div>

                    <!-- ê´€ë¦¬ (í•­ìƒ ë³´ì´ê²Œ; í´ë¦­ ê°€ë“œëŠ” app.jsê°€ ì²˜ë¦¬) -->
                    <div
                        class="item"
                        ng-mouseenter="onMenuEnter(mAdmin)"
                        ng-mouseleave="onMenuLeave(mAdmin)"
                    >
                        <a
                            href="#/admin"
                            ng-click="navTo('#/admin', $event)"
                            aria-haspopup="true"
                            aria-expanded="{{!!mAdmin._open}}"
                            >ê´€ë¦¬</a
                        >
                        <div
                            class="dropdown"
                            ng-show="mAdmin._open"
                            ng-click="$event.stopPropagation()"
                        >
                            <a
                                href="#/db-users"
                                ng-click="navTo('#/db-users', $event)"
                                >DB ì‚¬ìš©ì ê´€ë¦¬</a
                            >
                            <a
                                href="#/roles"
                                ng-click="navTo('#/roles', $event)"
                                >ê¶Œí•œ ê´€ë¦¬</a
                            >
                        </div>
                    </div>
                </nav>

                <div class="nav-right">
                    <span id="whoami"></span>
                    <a
                        href="#"
                        id="btn-delete"
                        class="btn-link"
                        style="display: none"
                        >ê³„ì • íƒˆí‡´</a
                    >
                    <a
                        href="/logout"
                        class="btn-link"
                        >ë¡œê·¸ì•„ì›ƒ</a
                    >
                </div>
            </div>
        </div>

        <main>
            <!-- í™ˆ -->
            <section
                id="welcome"
                role="region"
                aria-label="í™˜ì˜"
                ng-if="showWelcome"
            >
                <div class="hero">
                    <div>
                        <h2>í™ˆí˜ì´ì§€ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‘‹</h2>
                        <p>ìƒë‹¨ ë©”ë‰´ì—ì„œ ì›í•˜ì‹œëŠ” ê¸°ëŠ¥ì„ ì„ íƒí•˜ì—¬ ì´ìš©í•´ ì£¼ì„¸ìš”.</p>
                    </div>
                </div>
            </section>

            <!-- ë²„ìŠ¤ íƒ­ -->
            <section
                id="tab-bus"
                role="region"
                aria-label="ë²„ìŠ¤ ì •ë³´"
                ng-if="showBusTab"
            >
                <div ng-controller="BusController">
                    <section>
                        <div class="search-box">
                            <input
                                type="text"
                                ng-model="keyword"
                                placeholder="ì •ë¥˜ì¥ ì´ë¦„ ê²€ìƒ‰"
                            />
                            <button
                                type="button"
                                ng-click="filterData()"
                            >
                                ê²€ìƒ‰
                            </button>
                        </div>

                        <div class="generate-button">
                            <button
                                type="button"
                                ng-click="loadData()"
                            >
                                ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                            </button>
                        </div>

                        <div
                            class="status-box"
                            ng-if="statusMessage"
                            ng-class="{'status-success':statusType==='success','status-error':statusType==='error','status-info':statusType==='info'}"
                        >
                            {{ statusMessage }}
                        </div>

                        <div id="output">
                            <h3 ng-if="filteredItems.length">ğŸ“‹ ì¡°íšŒ ê²°ê³¼</h3>
                            <ul>
                                <li ng-repeat="item in filteredItems"><strong>{{ item.bsNm || 'ì´ë¦„ ì—†ìŒ' }}</strong> ({{ item.xPos }}, {{ item.yPos }})</li>
                            </ul>
                            <p ng-if="!filteredItems.length && items.length">ğŸ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p ng-if="!items.length">ğŸ“­ ë°ì´í„°ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>
                        </div>
                    </section>
                </div>
            </section>

            <!-- ë¼ìš°íŠ¸ ì˜ì—­ -->
            <div ng-view></div>
        </main>

        <!-- ë¡œê·¸ì¸/ê¶Œí•œ/íƒˆí‡´ ìŠ¤í¬ë¦½íŠ¸ (ê¸°ì¡´ ìœ ì§€) -->
        <script>
            (function () {
                try {
                    if (window.angular) {
                        var body = document.querySelector('body[ng-controller]');
                        var s = body ? angular.element(body).scope() : null;
                        if (s)
                            s.$applyAsync(function () {
                                s.__isAdmin = false;
                                s.isAdmin = false;
                            });
                    }
                } catch (e) {}
                window.__IS_ADMIN__ = false;

                fetch('/api/me', { credentials: 'same-origin' })
                    .then(function (res) {
                        const redirectedToLogin = res.redirected && /\/login(?:\?|$)/.test(res.url);
                        const ct = (res.headers.get('content-type') || '').toLowerCase();
                        const notJson = ct.indexOf('application/json') === -1;
                        if (res.status === 401 || redirectedToLogin || notJson) {
                            window.location.href = '/login';
                            return null;
                        }
                        return res.json();
                    })
                    .then(function (data) {
                        if (!data) return;
                        var who = document.getElementById('whoami');
                        if (who && data.username) who.textContent = 'ì•ˆë…•í•˜ì„¸ìš”, ' + data.username + 'ë‹˜';

                        // ê´€ë¦¬ì ì—¬ë¶€ ì „ì—­ ë³´ê´€(ë©”ë‰´ëŠ” í•­ìƒ ë³´ì´ì§€ë§Œ í´ë¦­ ê°€ë“œì—ì„œ ì‚¬ìš©)
                        var isAdmin = !!(
                            data &&
                            (data.isAdmin ||
                                data.admin ||
                                (Array.isArray(data.authorities) && data.authorities.some((a) => ((a && a.authority) || a) === 'ROLE_ADMIN')) ||
                                (Array.isArray(data.roles) && data.roles.some((r) => ((r && r.role) || r) === 'ROLE_ADMIN')) ||
                                (Array.isArray(data.roleList) && data.roleList.some((r) => ((r && r.role) || r) === 'ROLE_ADMIN')))
                        );
                        window.__IS_ADMIN__ = isAdmin;

                        try {
                            if (window.angular) {
                                var body = document.querySelector('body[ng-controller]');
                                var s = body ? angular.element(body).scope() : null;
                                if (s)
                                    s.$applyAsync(function () {
                                        s.__isAdmin = isAdmin;
                                        s.isAdmin = isAdmin;
                                    });
                            }
                        } catch (e) {}

                        var delBtn = document.getElementById('btn-delete');
                        if (delBtn) delBtn.style.display = 'inline-block';
                    })
                    .catch(function () {
                        window.location.href = '/login';
                    });

                document.addEventListener('click', function (e) {
                    if (e.target && e.target.id === 'btn-delete') {
                        e.preventDefault();
                        if (!confirm('ì •ë§ë¡œ ë‚´ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ì–´ìš”? ì´ ë™ì‘ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
                        fetch('/api/me', { method: 'DELETE', credentials: 'same-origin' })
                            .then(function (res) {
                                if (res.status === 204 || res.status === 200) {
                                    alert('ê³„ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                    window.location.href = '/logout';
                                } else if (res.status === 401) {
                                    window.location.href = '/login';
                                } else {
                                    return res.text().then(function (t) {
                                        throw new Error(t || 'ì‚­ì œ ì‹¤íŒ¨');
                                    });
                                }
                            })
                            .catch(function (err) {
                                alert(err.message || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            });
                    }
                });
            })();
        </script>
    </body>
</html>
