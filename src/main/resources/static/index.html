<!DOCTYPE html>
<html
    lang="ko"
    ng-app="busApp"
>
    <head>
        <meta charset="UTF-8" />
        <title>ì‹¤ìŠµ í”„ë¡œì íŠ¸</title>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1"
        />

        <!-- AngularJS -->
        <script src="/lib/angular.js"></script>
        <script src="/lib/angular-route.js"></script>
        <!-- App -->
        <script src="/app.js"></script>

        <style>
            [ng-cloak] {
                display: none;
            }

            :root {
                --blue: #3478f6;
                --blue-600: #2c63ca;
                --gray-100: #f5f7fb;
                --gray-200: #edf0f5;
                --gray-400: #cfd7e3;
                --text-600: #2c3e50;
                --green: #2ecc71;
                --danger: #e74c3c;
            }

            html,
            body {
                height: 100%;
            }
            body {
                font-family: 'Segoe UI', system-ui, -apple-system, Roboto, Apple SD Gothic Neo, Malgun Gothic, sans-serif;
                background: #f7f9fc;
                margin: 0;
                color: #1f2d3d;
            }

            /* Top bar */
            .topbar {
                background: #3498db;
                color: #fff;
                padding: 12px 16px;
            }
            .topbar .inner {
                max-width: 1100px;
                margin: 0 auto;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
            }
            .brand {
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 700;
                font-size: 18px;
                margin-left: 4px;
            }

            /* ê°€ìš´ë° íƒ­ */
            .tabs {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-left: auto;
                margin-right: auto;
            }
            .tab {
                display: inline-block;
                padding: 8px 12px;
                border-radius: 8px;
                text-decoration: none;
                color: #fff;
                border: 1px solid rgba(255, 255, 255, 0.35);
                transition: 0.15s;
                font-size: 14px;
            }
            .tab:hover {
                background: rgba(255, 255, 255, 0.12);
            }
            .tab.active {
                color: #111827;
                background: #fff;
                border-color: #fff;
            }

            .nav-right {
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 14px;
            }
            .btn-link {
                color: #fff;
                text-decoration: none;
                border: 1px solid rgba(255, 255, 255, 0.6);
                padding: 6px 10px;
                border-radius: 10px;
                transition: 0.15s;
            }
            .btn-link:hover {
                background: rgba(255, 255, 255, 0.12);
            }

            main {
                max-width: 980px;
                margin: 28px auto 40px;
                padding: 20px;
                background: #fff;
                border-radius: 16px;
                box-shadow: 0 10px 30px rgba(31, 38, 135, 0.08);
            }

            .search-box {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 10px;
                margin-bottom: 16px;
            }
            .search-box input {
                padding: 10px 12px;
                width: 60%;
                font-size: 16px;
                border: 1px solid var(--gray-400);
                border-radius: 10px;
            }
            .search-box button {
                padding: 10px 16px;
                background: var(--green);
                color: #fff;
                border: 0;
                border-radius: 10px;
                cursor: pointer;
            }

            .generate-button {
                display: flex;
                justify-content: center;
                margin-bottom: 16px;
            }
            .generate-button button {
                padding: 10px 20px;
                background: #3498db;
                color: #fff;
                border: 0;
                border-radius: 10px;
                font-size: 16px;
                cursor: pointer;
            }

            .status-box {
                margin-bottom: 16px;
                text-align: center;
                font-size: 15px;
                padding: 10px;
                border-radius: 10px;
            }
            .status-success {
                background: #e8f5e9;
                color: #2e7d32;
                border: 1px solid #c8e6c9;
            }
            .status-error {
                background: #ffebee;
                color: #c62828;
                border: 1px solid #ef9a9a;
            }
            .status-info {
                background: #e3f2fd;
                color: #1565c0;
                border: 1px solid #90caf9;
            }

            #output {
                max-height: 400px;
                overflow-y: auto;
                padding: 15px;
                border: 1px solid #edf0f5;
                border-radius: 12px;
                background: #fbfdff;
            }
            ul {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            li {
                margin-bottom: 8px;
                font-size: 16px;
                line-height: 1.4;
            }
            strong {
                color: #2c3e50;
            }

            .user-table {
                width: 100%;
                border-collapse: collapse;
                background: #fff;
                border-radius: 12px;
                overflow: hidden;
                border: 1px solid #edf0f5;
            }
            .user-table th,
            .user-table td {
                border-bottom: 1px solid #eee;
                padding: 10px 12px;
                text-align: left;
                font-size: 14px;
                vertical-align: middle;
            }
            .user-table thead th {
                background: #f5f7fb;
                font-weight: 600;
            }
            .user-table tbody tr:hover td {
                background: #fbfdff;
            }

            .inline-input {
                width: 95%;
                padding: 6px 8px;
                border: 1px solid #d6dbe7;
                border-radius: 8px;
            }

            .section-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin: 6px 0 14px;
            }
            .section-title {
                display: flex;
                align-items: center;
                gap: 10px;
                color: var(--text-600);
            }
            .section-title .dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: var(--blue);
                box-shadow: 0 0 0 3px rgba(52, 120, 246, 0.15);
            }
            .actions {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .btn {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 9px 14px;
                border-radius: 10px;
                border: 1px solid var(--gray-400);
                background: #fff;
                color: #263238;
                cursor: pointer;
                font-weight: 600;
                transition: 0.15s;
            }
            .btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
            }
            .btn-primary {
                border-color: var(--blue);
                background: var(--blue);
                color: #fff;
            }
            .btn-primary:hover {
                background: var(--blue-600);
                border-color: var(--blue-600);
            }
            .btn-ghost {
                background: #fff;
                color: #2c3e50;
                border-color: var(--gray-400);
            }
            .btn-danger {
                border-color: var(--danger);
                background: var(--danger);
                color: #fff;
            }

            .pill {
                padding: 3px 8px;
                border-radius: 999px;
                font-size: 12px;
                border: 1px solid var(--gray-400);
            }
            .pill.green {
                background: #e8f5e9;
                color: #2e7d32;
                border-color: #c8e6c9;
            }
            .pill.gray {
                background: #f1f1f1;
                color: #555;
            }

            /* íƒ­ íŒ¨ë„ í‘œì‹œ/ìˆ¨ê¹€ */
            .tab-panel {
                display: none;
            }
            .tab-panel.show {
                display: block;
            }

            /* í™œì„±/ë¹„í™œì„± í† ê¸€ */
            .toggle-wrap {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .toggle-wrap input[type='checkbox'] {
                transform: scale(1.2);
            }
        </style>
    </head>

    <body
        ng-controller="RootCtrl"
        ng-cloak
    >
        <!-- Top bar -->
        <div class="topbar">
            <div class="inner">
                <div class="brand"><span>ì‹¤ìŠµ í”„ë¡œì íŠ¸</span></div>

                <nav
                    class="tabs"
                    role="tablist"
                    aria-label="ê¸°ëŠ¥ íƒ­"
                >
                    <a
                        id="tablink-bus"
                        href="#tab-bus"
                        class="tab active"
                        role="tab"
                        aria-selected="true"
                        >ë²„ìŠ¤</a
                    >
                    <a
                        id="tablink-dbusers"
                        href="#tab-dbusers"
                        class="tab"
                        role="tab"
                        aria-selected="false"
                        >DB ì‚¬ìš©ì ê´€ë¦¬</a
                    >
                    <a
                        id="tablink-roles"
                        href="#tab-roles"
                        class="tab"
                        role="tab"
                        aria-selected="false"
                        >ê¶Œí•œ</a
                    >
                </nav>

                <div class="nav-right">
                    <span id="whoami"></span>
                    <!-- âœ… ë¡œê·¸ì¸ í›„ ë…¸ì¶œë  ë‚´ ê³„ì • íƒˆí‡´ ë²„íŠ¼ -->
                    <a
                        href="#"
                        id="btn-delete"
                        class="btn-link"
                        style="display: none"
                        >ê³„ì • íƒˆí‡´</a
                    >
                    <a
                        href="/logout"
                        class="btn-link"
                        >ë¡œê·¸ì•„ì›ƒ</a
                    >
                </div>
            </div>
        </div>

        <main>
            <!-- íƒ­: ë²„ìŠ¤ -->
            <section
                id="tab-bus"
                class="tab-panel show"
                role="tabpanel"
            >
                <div
                    ng-show="isListView()"
                    ng-controller="BusController"
                >
                    <section>
                        <div class="search-box">
                            <input
                                type="text"
                                ng-model="keyword"
                                placeholder="ì •ë¥˜ì¥ ì´ë¦„ ê²€ìƒ‰"
                            />
                            <button
                                type="button"
                                ng-click="filterData()"
                            >
                                ê²€ìƒ‰
                            </button>
                        </div>

                        <div class="generate-button">
                            <button
                                type="button"
                                ng-click="loadData()"
                            >
                                ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                            </button>
                        </div>

                        <div
                            class="status-box"
                            ng-if="statusMessage"
                            ng-class="{'status-success': statusType==='success','status-error': statusType==='error','status-info': statusType==='info'}"
                        >
                            {{ statusMessage }}
                        </div>

                        <div id="output">
                            <h3 ng-if="filteredItems.length">ğŸ“‹ ì¡°íšŒ ê²°ê³¼</h3>
                            <ul>
                                <li ng-repeat="item in filteredItems"><strong>{{ item.bsNm || 'ì´ë¦„ ì—†ìŒ' }}</strong> ({{ item.xPos }}, {{ item.yPos }})</li>
                            </ul>
                            <p ng-if="!filteredItems.length && items.length">ğŸ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p ng-if="!items.length">ğŸ“­ ë°ì´í„°ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>
                        </div>
                    </section>

                    <!-- ë¼ìš°íŠ¸ ë·°(/users/new ë“±)ë„ ë²„ìŠ¤ íƒ­ì—ì„œ ì‚¬ìš© -->
                    <div
                        ng-view
                        ng-show="!isListView()"
                    ></div>
                </div>
            </section>

            <!-- íƒ­: DB ì‚¬ìš©ì ê´€ë¦¬ -->
            <section
                id="tab-dbusers"
                class="tab-panel"
                role="tabpanel"
                hidden
            >
                <div ng-controller="BusController">
                    <!-- ëª©ë¡(ë¦¬ìŠ¤íŠ¸ ê²½ë¡œì—ì„œë§Œ ë…¸ì¶œ) -->
                    <div ng-show="isListView()">
                        <section style="margin-top: 8px">
                            <div class="section-header">
                                <div class="section-title">
                                    <span class="dot"></span>
                                    <h2 style="margin: 0">ì‚¬ìš©ì ì •ë³´</h2>
                                </div>
                                <div class="actions">
                                    <button
                                        type="button"
                                        class="btn btn-ghost"
                                        ng-click="loadUsers()"
                                    >
                                        <span>ğŸ”„</span> ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-primary"
                                        ng-click="goToNew()"
                                    >
                                        <span>â•</span> ìƒˆ ì‚¬ìš©ì
                                    </button>
                                </div>
                            </div>

                            <div
                                class="status-box"
                                ng-if="userStatusMessage"
                                ng-class="{'status-success': userStatusType==='success','status-error': userStatusType==='error','status-info': userStatusType==='info'}"
                                style="margin-top: 0"
                            >
                                {{ userStatusMessage }}
                            </div>

                            <div id="users-output">
                                <table
                                    class="user-table"
                                    ng-if="users.length"
                                >
                                    <thead>
                                        <tr>
                                            <th style="width: 80px">ID</th>
                                            <th style="width: 160px">ì´ë¦„</th>
                                            <th>ì´ë©”ì¼</th>
                                            <th style="width: 200px">ìƒì„±ì‹œê°</th>
                                            <th style="width: 160px">ìˆ˜ì •</th>
                                            <th style="width: 90px">ì‚­ì œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="u in users track by u.id">
                                            <td>{{ u.id }}</td>
                                            <td>
                                                <span ng-if="!u._editing">{{ u.name }}</span>
                                                <input
                                                    ng-if="u._editing"
                                                    class="inline-input"
                                                    type="text"
                                                    ng-model="u._editName"
                                                />
                                            </td>
                                            <td>
                                                <span ng-if="!u._editing">{{ u.email }}</span>
                                                <input
                                                    ng-if="u._editing"
                                                    class="inline-input"
                                                    type="email"
                                                    ng-model="u._editEmail"
                                                />
                                            </td>
                                            <td>{{ u.created_at }}</td>
                                            <td>
                                                <button
                                                    type="button"
                                                    ng-if="!u._editing"
                                                    class="btn btn-ghost"
                                                    ng-click="startEdit(u)"
                                                >
                                                    ìˆ˜ì •
                                                </button>
                                                <div
                                                    ng-if="u._editing"
                                                    style="display: flex; gap: 8px"
                                                >
                                                    <button
                                                        type="button"
                                                        class="btn btn-primary"
                                                        ng-click="saveEdit(u)"
                                                    >
                                                        ì €ì¥
                                                    </button>
                                                    <button
                                                        type="button"
                                                        class="btn"
                                                        ng-click="cancelEdit(u)"
                                                    >
                                                        ì·¨ì†Œ
                                                    </button>
                                                </div>
                                            </td>
                                            <td>
                                                <button
                                                    type="button"
                                                    class="btn btn-danger"
                                                    ng-click="deleteUser(u)"
                                                >
                                                    ì‚­ì œ
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>

                                <div
                                    ng-if="!users.length"
                                    class="empty-card"
                                >
                                    <div class="empty-emoji">ğŸ—‚ï¸</div>
                                    <div class="empty-text">
                                        <strong>ì•„ì§ ì‚¬ìš©ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</strong><br />
                                        ìš°ì¸¡ ìƒë‹¨ì˜ <em>â€œìƒˆ ì‚¬ìš©ìâ€</em> ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ê±°ë‚˜, <em>â€œì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°â€</em>ë¥¼ ëˆŒëŸ¬ ìµœì‹  ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>

                    <!-- í¼/ë¼ìš°íŠ¸ í™”ë©´(ë¦¬ìŠ¤íŠ¸ê°€ ì•„ë‹ ë•Œë§Œ ë…¸ì¶œ) -->
                    <div
                        ng-view
                        ng-show="!isListView()"
                    ></div>
                </div>
            </section>

            <!-- íƒ­: ê¶Œí•œ -->
            <section
                id="tab-roles"
                class="tab-panel"
                role="tabpanel"
                hidden
                ng-controller="RoleCtrl"
            >
                <section>
                    <div class="section-header">
                        <div class="section-title">
                            <span class="dot"></span>
                            <h2 style="margin: 0">ê¶Œí•œ ê´€ë¦¬</h2>
                        </div>
                        <div class="actions">
                            <button
                                class="btn btn-ghost"
                                ng-click="load()"
                                ng-disabled="loading"
                            >
                                ğŸ”„ ìƒˆë¡œê³ ì¹¨
                            </button>
                        </div>
                    </div>

                    <div
                        class="status-box"
                        ng-if="msg"
                        ng-class="{'status-success': msgType==='success','status-error': msgType==='error','status-info': msgType==='info'}"
                    >
                        {{ msg }}
                    </div>

                    <table
                        class="user-table"
                        ng-if="rows.length"
                    >
                        <thead>
                            <tr>
                                <th style="width: 260px">ì‚¬ìš©ì</th>
                                <th style="width: 220px">ê¶Œí•œ</th>
                                <th style="width: 200px">ìƒíƒœ</th>
                                <th style="width: 120px">ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="r in rows track by r.username">
                                <td><strong>{{ r.username }}</strong></td>
                                <td>
                                    <select
                                        ng-model="r.role"
                                        ng-options="v for v in roleOptions"
                                        class="inline-input"
                                        style="width: 200px"
                                    ></select>
                                </td>
                                <td>
                                    <div class="toggle-wrap">
                                        <input
                                            id="en_{{::$index}}"
                                            type="checkbox"
                                            ng-model="r.enabled"
                                        />
                                        <label for="en_{{::$index}}">{{ r.enabled ? 'í™œì„±' : 'ë¹„í™œì„±' }}</label>
                                        <span
                                            class="pill"
                                            ng-class="r.enabled ? 'green' : 'gray'"
                                            >{{ r.enabled ? 'ON' : 'OFF' }}</span
                                        >
                                    </div>
                                </td>
                                <td>
                                    <button
                                        class="btn btn-primary"
                                        ng-click="save(r)"
                                        ng-disabled="saving"
                                    >
                                        ì €ì¥
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div
                        ng-if="!rows.length"
                        class="empty-card"
                    >
                        <div class="empty-emoji">ğŸ›¡ï¸</div>
                        <div class="empty-text">
                            <strong>ê¶Œí•œ íƒ­ ìë¦¬ì…ë‹ˆë‹¤.</strong><br />
                            ë‚˜ì¤‘ì— ROLE_USER / ROLE_ADMIN ê´€ë¦¬ UIë¥¼ ì—¬ê¸°ì— ë¶™ì´ë©´ ë©ë‹ˆë‹¤.
                        </div>
                    </div>
                </section>
            </section>
        </main>

        <!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ìëª…/ê¶Œí•œ íƒ­ ê°€ì‹œì„± + íƒˆí‡´ ë²„íŠ¼ ë…¸ì¶œ/ë™ì‘ -->
        <script>
            (function () {
                fetch('/api/me', { credentials: 'same-origin' })
                    .then(function (res) {
                        if (res.status === 401) {
                            window.location.href = '/login';
                            return null;
                        }
                        return res.json();
                    })
                    .then(function (data) {
                        if (!data) return;
                        var who = document.getElementById('whoami');
                        if (who && data.username) who.textContent = 'ì•ˆë…•í•˜ì„¸ìš”, ' + data.username + 'ë‹˜';

                        // ê´€ë¦¬ì ì—¬ë¶€: /api/me ì˜ isAdmin í”Œë˜ê·¸ ë˜ëŠ” authorities ë°°ì—´
                        var isAdmin = !!(data && (data.isAdmin || (Array.isArray(data.authorities) && data.authorities.indexOf('ROLE_ADMIN') !== -1)));

                        var rolesLink = document.getElementById('tablink-roles');
                        var rolesPanel = document.getElementById('tab-roles');

                        if (!isAdmin && rolesLink) {
                            rolesLink.style.display = 'none';
                            if (location.hash === '#tab-roles') {
                                history.replaceState(null, '', '#tab-bus');
                            }
                            if (rolesPanel) rolesPanel.hidden = true;
                        }

                        // âœ… ë¡œê·¸ì¸ ìƒíƒœë©´ ê³„ì • íƒˆí‡´ ë²„íŠ¼ ë…¸ì¶œ
                        var delBtn = document.getElementById('btn-delete');
                        if (delBtn) delBtn.style.display = 'inline-block';
                    })
                    .catch(function () {});
            })();

            // âœ… ê³„ì • íƒˆí‡´ í´ë¦­ í•¸ë“¤ëŸ¬
            document.addEventListener('click', function (e) {
                if (e.target && e.target.id === 'btn-delete') {
                    e.preventDefault();
                    if (!confirm('ì •ë§ë¡œ ë‚´ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ì–´ìš”? ì´ ë™ì‘ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

                    fetch('/api/me', { method: 'DELETE', credentials: 'same-origin' })
                        .then(function (res) {
                            if (res.status === 204 || res.status === 200) {
                                alert('ê³„ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                // ì„¸ì…˜ ì¢…ë£Œë¥¼ ìœ„í•´ ë¡œê·¸ì•„ì›ƒ ê²½ë¡œë¡œ ì´ë™
                                window.location.href = '/logout';
                            } else if (res.status === 401) {
                                window.location.href = '/login';
                            } else {
                                return res.text().then(function (t) {
                                    throw new Error(t || 'ì‚­ì œ ì‹¤íŒ¨');
                                });
                            }
                        })
                        .catch(function (err) {
                            alert(err.message || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        });
                }
            });
        </script>

        <!-- ê°„ë‹¨ íƒ­ ì „í™˜ ìŠ¤í¬ë¦½íŠ¸ -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const tabs = document.querySelectorAll('.tabs .tab');
                const panels = document.querySelectorAll('.tab-panel');

                function activate(hash) {
                    tabs.forEach((a) => {
                        if (a.style.display === 'none') return; // ìˆ¨ê²¨ì§„ íƒ­ì€ ì œì™¸
                        const on = a.getAttribute('href') === hash;
                        a.classList.toggle('active', on);
                        a.setAttribute('aria-selected', String(on));
                    });
                    panels.forEach((p) => {
                        const on = '#' + p.id === hash;
                        p.classList.toggle('show', on);
                        p.hidden = !on;
                    });
                }

                tabs.forEach((a) => {
                    a.addEventListener('click', function (e) {
                        if (a.style.display === 'none') return;
                        e.preventDefault();
                        const hash = a.getAttribute('href');
                        history.replaceState(null, '', hash);
                        activate(hash);
                    });
                });

                let initial = location.hash || '#tab-bus';
                const rolesLink = document.getElementById('tablink-roles');
                if (initial === '#tab-roles' && rolesLink && rolesLink.style.display === 'none') {
                    initial = '#tab-bus';
                    history.replaceState(null, '', initial);
                }
                activate(initial);
            });
        </script>

        <!-- ê¶Œí•œ íƒ­ìš© Angular ì»¨íŠ¸ë¡¤ëŸ¬ -->
        <script>
            angular.module('busApp').controller('RoleCtrl', function ($scope, $http) {
                $scope.rows = [];
                $scope.roleOptions = ['ROLE_USER', 'ROLE_ADMIN'];
                $scope.loading = false;
                $scope.saving = false;
                $scope.msg = '';
                $scope.msgType = 'info';

                function notify(type, text) {
                    $scope.msgType = type;
                    $scope.msg = text;
                    setTimeout(function () {
                        $scope.$applyAsync(function () {
                            $scope.msg = '';
                        });
                    }, 2500);
                }

                $scope.load = function () {
                    $scope.loading = true;
                    $http
                        .get('/api/roles')
                        .then(function (res) {
                            $scope.rows = res.data || [];
                            notify('info', 'ê¶Œí•œ ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                        })
                        .catch(function () {
                            notify('error', 'ê¶Œí•œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                        })
                        .finally(function () {
                            $scope.loading = false;
                        });
                };

                $scope.save = function (row) {
                    if (!row || !row.username || !row.role) return;
                    $scope.saving = true;
                    // role + enabled ëª¨ë‘ ì „ì†¡
                    $http
                        .put('/api/roles/' + encodeURIComponent(row.username), {
                            role: row.role,
                            enabled: row.enabled,
                        })
                        .then(function () {
                            notify('success', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        })
                        .catch(function (err) {
                            var msg = err && err.data ? err.data : 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                            notify('error', msg);
                        })
                        .finally(function () {
                            $scope.saving = false;
                        });
                };

                // ì´ˆê¸° ë¡œë“œ
                $scope.load();
            });
        </script>
    </body>
</html>
